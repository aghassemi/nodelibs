// Copyright Joyent, Inc. and other Node contributors.
function Url(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}function urlParse(e,t,r){if(e&&util.isObject(e)&&e instanceof Url)return e;var n=new Url;return n.parse(e,t,r),n}function urlFormat(e){return util.isString(e)&&(e=urlParse(e)),e instanceof Url?e.format():Url.prototype.format.call(e)}function urlResolve(e,t){return urlParse(e,!1,!0).resolve(t)}function urlResolveObject(e,t){return e?urlParse(e,!1,!0).resolveObject(t):t}var punycode=require("./punycode"),util=require("./util");exports.parse=urlParse,exports.resolve=urlResolve,exports.resolveObject=urlResolveObject,exports.format=urlFormat,exports.Url=Url;var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,delims=["<",">",'"',"`"," ","\r","\n","	"],unwise=["{","}","|","\\","^","`"].concat(delims),autoEscape=["'"].concat(unwise),nonHostChars=["%","/","?",";","#"].concat(autoEscape),hostEndingChars=["/","?","#"],hostnameMaxLen=255,hostnamePartPattern=/^[a-z0-9A-Z_-]{0,63}$/,hostnamePartStart=/^([a-z0-9A-Z_-]{0,63})(.*)$/,unsafeProtocol={javascript:!0,"javascript:":!0},hostlessProtocol={javascript:!0,"javascript:":!0},slashedProtocol={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},querystring=require("./querystring");Url.prototype.parse=function(e,t,r){if(!util.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var n=e;n=n.trim();var i=protocolPattern.exec(n);if(i){i=i[0];var s=i.toLowerCase();this.protocol=s,n=n.substr(i.length)}if(r||i||n.match(/^\/\/[^@\/]+@[^@\/]+/)){var o="//"===n.substr(0,2);!o||i&&hostlessProtocol[i]||(n=n.substr(2),this.slashes=!0)}if(!hostlessProtocol[i]&&(o||i&&!slashedProtocol[i])){for(var a=-1,u=0;u<hostEndingChars.length;u++){var h=n.indexOf(hostEndingChars[u]);-1!==h&&(-1===a||a>h)&&(a=h)}var f,c;c=-1===a?n.lastIndexOf("@"):n.lastIndexOf("@",a),-1!==c&&(f=n.slice(0,c),n=n.slice(c+1),this.auth=decodeURIComponent(f)),a=-1;for(var u=0;u<nonHostChars.length;u++){var h=n.indexOf(nonHostChars[u]);-1!==h&&(-1===a||a>h)&&(a=h)}-1===a&&(a=n.length),this.host=n.slice(0,a),n=n.slice(a),this.parseHost(),this.hostname=this.hostname||"";var l="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!l)for(var d=this.hostname.split(/\./),u=0,p=d.length;p>u;u++){var g=d[u];if(g&&!g.match(hostnamePartPattern)){for(var m="",v=0,b=g.length;b>v;v++)m+=g.charCodeAt(v)>127?"x":g[v];if(!m.match(hostnamePartPattern)){var y=d.slice(0,u),w=d.slice(u+1),_=g.match(hostnamePartStart);_&&(y.push(_[1]),w.unshift(_[2])),w.length&&(n="/"+w.join(".")+n),this.hostname=y.join(".");break}}}if(this.hostname=this.hostname.length>hostnameMaxLen?"":this.hostname.toLowerCase(),!l){for(var E=this.hostname.split("."),S=[],u=0;u<E.length;++u){var B=E[u];S.push(B.match(/[^A-Za-z0-9_-]/)?"xn--"+punycode.encode(B):B)}this.hostname=S.join(".")}var A=this.port?":"+this.port:"",x=this.hostname||"";this.host=x+A,this.href+=this.host,l&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==n[0]&&(n="/"+n))}if(!unsafeProtocol[s])for(var u=0,p=autoEscape.length;p>u;u++){var I=autoEscape[u],O=encodeURIComponent(I);O===I&&(O=escape(I)),n=n.split(I).join(O)}var L=n.indexOf("#");-1!==L&&(this.hash=n.substr(L),n=n.slice(0,L));var R=n.indexOf("?");if(-1!==R?(this.search=n.substr(R),this.query=n.substr(R+1),t&&(this.query=querystring.parse(this.query)),n=n.slice(0,R)):t&&(this.search="",this.query={}),n&&(this.pathname=n),slashedProtocol[s]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var A=this.pathname||"",B=this.search||"";this.path=A+B}return this.href=this.format(),this},Url.prototype.format=function(){var e=this.auth||"";e&&(e=encodeURIComponent(e),e=e.replace(/%3A/i,":"),e+="@");var t=this.protocol||"",r=this.pathname||"",n=this.hash||"",i=!1,s="";this.host?i=e+this.host:this.hostname&&(i=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(i+=":"+this.port)),this.query&&util.isObject(this.query)&&Object.keys(this.query).length&&(s=querystring.stringify(this.query));var o=this.search||s&&"?"+s||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||slashedProtocol[t])&&i!==!1?(i="//"+(i||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):i||(i=""),n&&"#"!==n.charAt(0)&&(n="#"+n),o&&"?"!==o.charAt(0)&&(o="?"+o),r=r.replace(/[?#]/g,function(e){return encodeURIComponent(e)}),o=o.replace("#","%23"),t+i+r+o+n},Url.prototype.resolve=function(e){return this.resolveObject(urlParse(e,!1,!0)).format()},Url.prototype.resolveObject=function(e){if(util.isString(e)){var t=new Url;t.parse(e,!1,!0),e=t}var r=new Url;if(Object.keys(this).forEach(function(e){r[e]=this[e]},this),r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol)return Object.keys(e).forEach(function(t){"protocol"!==t&&(r[t]=e[t])}),slashedProtocol[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r;if(e.protocol&&e.protocol!==r.protocol){if(!slashedProtocol[e.protocol])return Object.keys(e).forEach(function(t){r[t]=e[t]}),r.href=r.format(),r;if(r.protocol=e.protocol,e.host||hostlessProtocol[e.protocol])r.pathname=e.pathname;else{for(var n=(e.pathname||"").split("/");n.length&&!(e.host=n.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==n[0]&&n.unshift(""),n.length<2&&n.unshift(""),r.pathname=n.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var i=r.pathname||"",s=r.search||"";r.path=i+s}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var o=r.pathname&&"/"===r.pathname.charAt(0),a=e.host||e.pathname&&"/"===e.pathname.charAt(0),u=a||o||r.host&&e.pathname,h=u,f=r.pathname&&r.pathname.split("/")||[],n=e.pathname&&e.pathname.split("/")||[],c=r.protocol&&!slashedProtocol[r.protocol];if(c&&(r.hostname="",r.port=null,r.host&&(""===f[0]?f[0]=r.host:f.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===n[0]?n[0]=e.host:n.unshift(e.host)),e.host=null),u=u&&(""===n[0]||""===f[0])),a)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,f=n;else if(n.length)f||(f=[]),f.pop(),f=f.concat(n),r.search=e.search,r.query=e.query;else if(!util.isNullOrUndefined(e.search)){if(c){r.hostname=r.host=f.shift();var l=r.host&&r.host.indexOf("@")>0?r.host.split("@"):!1;l&&(r.auth=l.shift(),r.host=r.hostname=l.shift())}return r.search=e.search,r.query=e.query,util.isNull(r.pathname)&&util.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r}if(!f.length)return r.pathname=null,r.path=r.search?"/"+r.search:null,r.href=r.format(),r;for(var d=f.slice(-1)[0],p=(r.host||e.host)&&("."===d||".."===d)||""===d,g=0,m=f.length;m>=0;m--)d=f[m],"."==d?f.splice(m,1):".."===d?(f.splice(m,1),g++):g&&(f.splice(m,1),g--);if(!u&&!h)for(;g--;g)f.unshift("..");!u||""===f[0]||f[0]&&"/"===f[0].charAt(0)||f.unshift(""),p&&"/"!==f.join("/").substr(-1)&&f.push("");var v=""===f[0]||f[0]&&"/"===f[0].charAt(0);if(c){r.hostname=r.host=v?"":f.length?f.shift():"";var l=r.host&&r.host.indexOf("@")>0?r.host.split("@"):!1;l&&(r.auth=l.shift(),r.host=r.hostname=l.shift())}return u=u||r.host&&f.length,u&&!v&&f.unshift(""),f.length?r.pathname=f.join("/"):(r.pathname=null,r.path=null),util.isNull(r.pathname)&&util.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},Url.prototype.parseHost=function(){var e=this.host,t=portPattern.exec(e);t&&(t=t[0],":"!==t&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)};